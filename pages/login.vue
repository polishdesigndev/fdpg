<template>
  <div id="page-login">
    <div ref="bg" class="bg"></div>
    <svg
      class="space-grid"
      xmlns="http://www.w3.org/2000/svg"
      width="890.686"
      height="705.168"
      viewBox="0 0 890.686 705.168"
    >
      <g
        id="Group_66"
        data-name="Group 66"
        transform="translate(0.378 -14.416)"
      >
        <g
          id="Group_2"
          data-name="Group 2"
          transform="translate(1368.749 681.118)"
          opacity="0.495"
        >
          <line
            id="Line_1"
            data-name="Line 1"
            y1="482.525"
            transform="translate(-1000.433 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <g
            id="Group_1"
            data-name="Group 1"
            transform="translate(-1368.749 -666.375)"
          >
            <path
              id="Path_1"
              data-name="Path 1"
              d="M-1368.749,242.393l96.284-111.08h794.024"
              transform="translate(1368.749 462.12)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_2"
              data-name="Path 2"
              d="M-1368.749,118.03l96.284-79.343h793.918"
              transform="translate(1368.749 485.837)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_3"
              data-name="Path 3"
              d="M-1368.749-6.332l96.284-47.606h793.812"
              transform="translate(1368.749 509.555)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_4"
              data-name="Path 4"
              d="M-1368.749-130.694l96.284-15.869H-478.76"
              transform="translate(1368.749 533.272)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_5"
              data-name="Path 5"
              d="M-1368.749-260.518l96.284,15.869h793.6"
              transform="translate(1368.749 562.452)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_6"
              data-name="Path 6"
              d="M-1368.749-395.8l96.284,47.606h793.493"
              transform="translate(1368.749 597.093)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_7"
              data-name="Path 7"
              d="M-1368.749-531.089l96.284,79.343h793.386"
              transform="translate(1368.749 631.734)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
            <path
              id="Path_8"
              data-name="Path 8"
              d="M-1368.749-666.375l96.284,111.08h793.28"
              transform="translate(1368.749 666.375)"
              fill="none"
              stroke="#d2d2d2"
              stroke-miterlimit="10"
              stroke-width="1"
            />
          </g>
          <line
            id="Line_2"
            data-name="Line 2"
            y1="482.871"
            transform="translate(-1272.465 -555.727)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_3"
            data-name="Line 3"
            y1="482.525"
            transform="translate(-1206.09 -555.381)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_4"
            data-name="Line 4"
            y1="571.39"
            transform="translate(-1310.4 -599.813)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_5"
            data-name="Line 5"
            y1="673.393"
            transform="translate(-1354.485 -650.815)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_6"
            data-name="Line 6"
            y1="482.525"
            transform="translate(-1138.743 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_7"
            data-name="Line 7"
            y1="482.525"
            transform="translate(-1070.453 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_8"
            data-name="Line 8"
            y1="482.525"
            transform="translate(-930.591 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_9"
            data-name="Line 9"
            y1="482.525"
            transform="translate(-860.661 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_10"
            data-name="Line 10"
            y1="482.525"
            transform="translate(-790.73 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_11"
            data-name="Line 11"
            y1="482.525"
            transform="translate(-720.8 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_12"
            data-name="Line 12"
            y1="482.525"
            transform="translate(-650.87 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_13"
            data-name="Line 13"
            y1="482.525"
            transform="translate(-580.939 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
          <line
            id="Line_14"
            data-name="Line 14"
            y1="482.525"
            transform="translate(-511.009 -555.034)"
            fill="none"
            stroke="#d2d2d2"
            stroke-miterlimit="10"
            stroke-width="1"
          />
        </g>
        <g
          id="Group_15"
          data-name="Group 15"
          transform="translate(-4.398 -15.706)"
        >
          <circle
            id="Ellipse_1"
            class="ball"
            data-name="Ellipse 1"
            cx="13.5"
            cy="13.5"
            r="13.5"
            transform="translate(49.398 579.706)"
            fill="#ff7a87"
          />
          <circle
            id="Ellipse_2"
            class="ball"
            data-name="Ellipse 2"
            cx="13.5"
            cy="13.5"
            r="13.5"
            transform="translate(289.398 610.706)"
            fill="#5383d9"
          />
          <ellipse
            id="Ellipse_4"
            class="ball"
            data-name="Ellipse 4"
            cx="13"
            cy="13.5"
            rx="13"
            ry="13.5"
            transform="translate(221.398 127.706)"
            fill="#ffc03d"
          />
          <ellipse
            id="Ellipse_5"
            class="ball"
            data-name="Ellipse 5"
            cx="13"
            cy="13.5"
            rx="13"
            ry="13.5"
            transform="translate(357.398 333.706)"
            fill="#ff7a87"
          />
          <circle
            id="Ellipse_6"
            class="ball"
            data-name="Ellipse 6"
            cx="13.5"
            cy="13.5"
            r="13.5"
            transform="translate(289.398 193.706)"
            fill="#5383d9"
          />
          <ellipse
            id="Ellipse_7"
            class="ball"
            data-name="Ellipse 7"
            cx="13"
            cy="13.5"
            rx="13"
            ry="13.5"
            transform="translate(50.398 162.706)"
            fill="#ff7a87"
          />
          <circle
            id="Ellipse_3"
            class="ball"
            data-name="Ellipse 3"
            cx="13.5"
            cy="13.5"
            r="13.5"
            transform="translate(153.398 540.706)"
            fill="#ac6eb3"
          />
        </g>
      </g>
    </svg>
    <img
      ref="logoLoader"
      class="logo-loader"
      src="~/assets/images/login/logo_loader.svg"
      alt="logo_loader"
    />
    <img
      ref="playerLoader"
      class="player-loader"
      src="~/assets/images/login/player_loader@2x.png"
      alt="player_loader"
    />
    <div class="login">
      <img
        ref="loginLogo"
        class="login__logo"
        src="~/assets/images/login/logo_playground.svg"
        alt="logo_playground"
      />
      <div ref="loginInputGroup" class="login__input-group">
        <form @submit.prevent="onSubmit">
          <input
            ref="loginInput"
            v-model="fdid"
            class="login__input"
            type="text"
            placeholder="輸入 Fourdeisre ID"
          />
          <button
            v-if="fdid"
            type="submit"
            :disabled="disableSubmit"
            class="login__submit"
          ></button>
        </form>
        <div v-if="error" class="login__error">{{ error }}</div>
      </div>
    </div>
    <div v-show="verifying" class="verify">
      <img
        ref="successBg"
        class="verify__success-bg"
        src="~/assets/images/login/success_bg@2x.png"
        alt="success_bg"
      />
      <div class="verify__block">
        <img
          ref="verifyLoader"
          class="verify__loader"
          src="~/assets/images/login/verify_loader.svg"
          alt="verify_loader"
        />
        <img
          ref="verifySuccess"
          class="verify__success"
          src="~/assets/images/login/verify_success.svg"
          alt="verify_success"
        />
        <p class="verify__msg">{{ verifyMsg }}</p>
      </div>
    </div>
  </div>
</template>

<script>
import revealLogin from '@/timelines/revealLogin'
import showVerifySuccess from '@/timelines/showVerifySuccess'
import { setUser } from '@/utils/user'
import { mapActions } from 'vuex'

export default {
  data() {
    return {
      fdid: '',
      error: '',
      disableSubmit: false,
      verifying: false,
      verifyMsg: '玩家身分審核中 ...',
    }
  },
  mounted() {
    revealLogin(this.$refs)
  },
  methods: {
    async onSubmit() {
      this.disableSubmit = true
      try {
        const resp = await this.$axios.$post(
          'https://j9dh3ne194.execute-api.ap-northeast-2.amazonaws.com/fdpg2021/authorize',
          {
            fdid: this.fdid.trim(),
          }
        )
        this.verifying = true

        setTimeout(() => {
          showVerifySuccess(this.$refs) // 驗證成功動畫
          setTimeout(() => {
            this.verifyMsg = '審核成功！'
          }, 800)
        }, 1000)
        setTimeout(() => {
          setUser(JSON.stringify(resp)) // 儲存
          this.$router.push('/') // 跳轉
          // 開始輪詢上線人數
          this.poll()
        }, 3000)
      } catch (error) {
        this.verifying = false
        this.error = '很抱歉，您並非入選玩家'
        this.disableSubmit = false
      }
    },
    ...mapActions('online', ['poll']),
  },
}
</script>
